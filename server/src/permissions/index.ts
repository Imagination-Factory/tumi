import { allow, shield } from 'graphql-shield';
import { GraphQLError } from 'graphql';
import * as Sentry from '@sentry/node';
import { SeverityLevel } from '@sentry/node';
import { GraphQLYogaError } from '@graphql-yoga/node';
import { isAdmin, isAuthenticated, isMember } from './rules';

export const permissions = shield(
  {
    Query: {
      blobUploadKey: allow,
      costItem: allow,
      costItemsForEvent: allow,
      currentTenant: allow,
      currentUser: allow,
      event: allow,
      eventRegistrationCode: allow,
      eventRegistrationCodes: allow,
      eventTemplate: isMember,
      eventTemplates: isMember,
      events: allow,
      getPaymentSetupSession: allow,
      invite: allow,
      invites: allow,
      lmuPurchases: isAdmin,
      logStats: isAdmin,
      logs: isAdmin,
      organizers: allow,
      photoShareKey: isAuthenticated,
      photos: isAuthenticated,
      photosOfEvent: allow,
      product: allow,
      productImageKey: isAdmin,
      products: allow,
      purchase: allow,
      purchases: isAdmin,
      registration: isAuthenticated,
      registrationCount: isAdmin,
      registrations: isAdmin,
      templateCategories: isMember,
      templateCategory: isMember,
      tenants: allow,
      userById: isAdmin,
      userSearchResultNum: isAdmin,
      userWithStatus: isMember,
      users: isAdmin,
    },
    Mutation: {
      addLineItemToBasket: allow,
      addOrganizerToEvent: allow,
      addReceiptToCostItem: allow,
      changeEventPublication: allow,
      checkInUser: allow,
      createEventFromTemplate: allow,
      createEventOrganizer: allow,
      createEventTemplate: allow,
      createInvites: allow,
      createPhotoShare: allow,
      createProduct: allow,
      createProductImage: allow,
      createPurchaseFromCart: allow,
      createRegistrationCode: allow,
      createSubmissionItem: allow,
      createSubmissionOnEvent: allow,
      decreaseLineItemQuantity: allow,
      deleteCostItem: allow,
      deleteEvent: isAdmin,
      deleteLineItem: allow,
      deleteProductImage: allow,
      deleteReceipt: allow,
      deleteSubmissionItem: allow,
      deleteTemplate: allow,
      deregisterFromEvent: allow,
      increaseLineItemQuantity: allow,
      rateEvent: allow,
      registerForEvent: allow,
      registerUser: allow,
      removeSubmissionFromEvent: allow,
      updateAddress: allow,
      updateCostItemsFromTemplate: allow,
      updateESNcard: allow,
      updateEventCoreInfo: allow,
      updateEventGeneralInfo: allow,
      updateEventLocation: allow,
      updateEventTemplateConnection: isAdmin,
      updateLeadImage: allow,
      updateProduct: allow,
      updateProfile: allow,
      updatePurchaseStatus: allow,
      updateTemplate: allow,
      updateTemplateFinances: allow,
      updateTemplateLocation: allow,
      updateTenant: allow,
      updateUserRole: allow,
      updateUserStatus: allow,
      useInvite: allow,
      useRegistrationCode: allow,
      verifyDCC: allow,
      verifyEmail: allow,
    },
    ActivityLog: allow,
    ActivityLogStat: allow,
    CostItem: allow,
    TumiEvent: allow,
    EventOrganizer: allow,
    EventRegistration: allow,
    EventRegistrationCode: allow,
    EventSubmission: allow,
    EventSubmissionItem: allow,
    EventTemplate: allow,
    EventTemplateCategory: allow,
    Invite: allow,
    LineItem: allow,
    PhotoShare: allow,
    Product: allow,
    ProductImage: allow,
    Purchase: allow,
    Receipt: allow,
    ShoppingCart: allow,
    statistics: allow,
    userHistoryItem: allow,
    lineChartSeriesItem: allow,
    StripePayment: allow,
    StripeUserData: allow,
    paymentSetupSession: allow,
    paymentIntent: allow,
    checkoutSession: allow,
    Tenant: allow,
    Transaction: allow,
    User: allow,
    UsersOfTenants: allow,
  },
  {
    fallbackRule: allow,
    allowExternalErrors: true,
    fallbackError: (err: unknown) => {
      Sentry.addBreadcrumb({
        category: 'shield',
        type: 'debug',
        message: 'Shield not authorized',
        level: 'warning' as SeverityLevel,
      });
      if (err) {
        Sentry.captureException(err);
        if (err instanceof Error) {
          return err;
        }
        if (err instanceof GraphQLYogaError) {
          return err;
        }
        if (err instanceof GraphQLError) {
          return err;
        }
      }
      return new Error('Not authorized!');
    },
  }
);
